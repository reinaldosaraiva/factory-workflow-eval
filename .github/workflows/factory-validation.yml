name: factory-validation

on:
  issues:
    types: [opened, edited, reopened, labeled]
  pull_request:
    types: [opened, edited, synchronize, reopened, labeled]
  workflow_dispatch:

jobs:
  validate_issue_contract:
    if: github.event_name == 'issues' && contains(toJson(github.event.issue.labels), 'factory')
    runs-on: ubuntu-latest
    steps:
      - name: Validate issue sections
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          required_sections=(
            "## User Story"
            "## Acceptance Criteria"
            "## Gherkin Scenarios"
            "## Technical Scope"
            "## Out of Scope"
            "## Evidence Checklist"
          )
          for section in "${required_sections[@]}"; do
            echo "$ISSUE_BODY" | grep -q "$section" || {
              echo "Missing required section: $section"
              exit 1
            }
          done
          echo "Issue contract validated."

  validate_pr_contract:
    if: github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'factory')
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title convention
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "$PR_TITLE" | grep -Eq '^(feat|fix|refactor|chore|docs|test|ci|perf)(\(.+\))?: .+' || {
            echo "PR title does not follow conventional commits."
            exit 1
          }
          echo "PR title convention validated."

      - name: Validate PR body evidence sections
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          required_sections=(
            "## Changes"
            "## Tests"
            "## Acceptance Criteria"
            "## Risks"
            "## Risk Matrix"
            "## Traceability"
            "## Execution Evidence"
            "## Evidence Records"
            "## Evidence"
          )
          for section in "${required_sections[@]}"; do
            echo "$PR_BODY" | grep -q "$section" || {
              echo "Missing required PR section: $section"
              exit 1
            }
          done

          execution_block="$(echo "$PR_BODY" | awk '
            /^## Execution Evidence/ {capture=1; next}
            /^## / && capture==1 {exit}
            capture==1 {print}
          ')"

          echo "$execution_block" | grep -Eq '^- Command: .+' || {
            echo "Execution evidence must include at least one '- Command: ...' line."
            exit 1
          }

          echo "$execution_block" | grep -Eq '^- Result: .+' || {
            echo "Execution evidence must include at least one '- Result: ...' line."
            exit 1
          }

          traceability_block="$(echo "$PR_BODY" | awk '
            /^## Traceability/ {capture=1; next}
            /^## / && capture==1 {exit}
            capture==1 {print}
          ')"

          echo "$traceability_block" | grep -Eq 'Issue URL:\s*https://github\.com/.+/issues/[0-9]+' || {
            echo "Traceability section must include a valid Issue URL."
            exit 1
          }

          echo "$traceability_block" | grep -Eq 'PR URL:\s*https://github\.com/.+/pull/[0-9]+' || {
            echo "Traceability section must include a valid PR URL."
            exit 1
          }

          echo "$traceability_block" | grep -Eq 'Run URL:\s*https://github\.com/.+/actions/runs/[0-9]+' || {
            echo "Traceability section must include a valid CI Run URL."
            exit 1
          }

          records_block="$(echo "$PR_BODY" | awk '
            /^## Evidence Records/ {capture=1; next}
            /^## / && capture==1 {exit}
            capture==1 {print}
          ')"

          echo "$records_block" | grep -Eq '^- EVIDENCE_COMMAND_1:\s*.+$' || {
            echo "Evidence Records must include '- EVIDENCE_COMMAND_1: ...'."
            exit 1
          }

          echo "$records_block" | grep -Eq '^- EVIDENCE_RESULT_1:\s*.+$' || {
            echo "Evidence Records must include '- EVIDENCE_RESULT_1: ...'."
            exit 1
          }

          echo "$records_block" | grep -Eq '^- EVIDENCE_ARTIFACT_1:\s*.+$' || {
            echo "Evidence Records must include '- EVIDENCE_ARTIFACT_1: ...'."
            exit 1
          }

          schema_version_line="$(echo "$records_block" | grep -E '^- EVIDENCE_SCHEMA_VERSION:\s*.+$' || true)"
          if [ -z "$schema_version_line" ]; then
            echo "Evidence Records must include '- EVIDENCE_SCHEMA_VERSION: v1'."
            exit 1
          fi

          schema_version="$(echo "$schema_version_line" | sed -E 's/^- EVIDENCE_SCHEMA_VERSION:\s*//')"
          if [ "$schema_version" != "v1" ]; then
            echo "Unsupported EVIDENCE_SCHEMA_VERSION: '$schema_version'. Expected 'v1'."
            exit 1
          fi

          echo "PR evidence contract validated."

  validate_model_policy:
    if: github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'factory')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enforce model policy (block gemini-2.5)
        run: |
          mapfile -t candidates < <(
            while IFS= read -r file; do
              if jq -e '.graph.nodes' "$file" >/dev/null 2>&1; then
                echo "$file"
              fi
            done < <(find . -type f -name "*.json")
          )

          if [ "${#candidates[@]}" -eq 0 ]; then
            echo "No workflow draft JSON files found in repo. Skipping model-policy file checks."
            exit 0
          fi

          failed=0
          for file in "${candidates[@]}"; do
            echo "Checking workflow draft file: $file"
            if ! scripts/factory/validate_no_gemini25_in_draft.sh --draft-file "$file"; then
              failed=1
            fi
          done

          if [ "$failed" -ne 0 ]; then
            echo "Model policy validation failed."
            exit 1
          fi

          echo "Model policy validation passed."

  validate_quality_security:
    if: github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'factory')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run quality and security baseline checks
        run: |
          chmod +x scripts/quality/run_quality_security_checks.sh
          chmod +x scripts/quality/scan_for_secrets.sh
          scripts/quality/run_quality_security_checks.sh

  validate_coverage:
    if: github.event_name == 'pull_request' && contains(toJson(github.event.pull_request.labels), 'factory')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install coverage dependency
        run: python3 -m pip install --disable-pip-version-check coverage

      - name: Run coverage gate
        run: |
          chmod +x scripts/quality/run_coverage_gate.sh
          scripts/quality/run_coverage_gate.sh 70
